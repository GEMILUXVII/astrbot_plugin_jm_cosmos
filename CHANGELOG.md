# 更新日志

所有版本更新记录。

## **v2.5.4** (2025-12-27)

### Bug 修复
- 修复 `/jmrec` 命令参数重复覆盖问题
  - 同类型参数（如 `new hot`）会被后续参数覆盖的 bug
  - 现在会检测重复参数并提示用户

### 改进
- 改进空结果提示信息，显示查询条件和建议
- 更新 README 添加关于空结果的说明（GitHub NOTE 横幅）

---

## **v2.5.3** (2025-12-27)

### 新增功能
- `/jmrank` 命令支持日排行榜
  - 新增 `day` 类型参数
  - `/jmrank day [页码]` - 查看日排行榜

---

## **v2.5.2** (2025-12-27)

### 架构优化
- 统一常量管理
  - 新增 `core/constants.py` 模块
  - 集中管理分类、排序、时间等常量映射
  - `JMBrowser` 和 `MessageFormatter` 共用常量
- 封面缓存机制优化

---

## **v2.5.1** (2025-12-27)

### Bug 修复
- 修复 `/jmc` 命令无法下载指定章节的问题
  - 原命令只接收一个参数（内部章节ID），用户无法使用
  - 现改为 `/jmc <本子ID> <章节序号>` 格式
  - 例如：`/jmc 1235104 3` 下载本子 1235104 的第 3 章

### 架构优化
- 新增 `browser.get_photo_id_by_index()` 方法，根据本子ID和章节序号获取章节信息

---

## **v2.5.0** (2025-12-27)

### 新增功能
- **推荐浏览功能** - 新增 `/jmrec` 命令，融合推荐与分类浏览
  - `/jmrec [分类] [排序] [时间] [页码]` - 灵活组合浏览条件
  - 支持 9 种分类：`all`/`doujin`/`single`/`short`/`hanman`/`meiman`/`3d`/`cosplay`/`another`
  - 支持 4 种排序：`hot`(热门)/`new`(最新)/`pic`(图多)/`like`(点赞)
  - 支持 4 种时间范围：`day`(今日)/`week`(本周)/`month`(本月)/`all`(全部)
  - 智能参数解析，顺序灵活
  - `/jmrec help` 查看详细帮助

### 架构优化
- 新增 `browser.get_category_albums()` 方法
- 新增 `formatter.format_recommend_results()` 格式化方法
- 在 `JMBrowser` 中添加分类/排序/时间常量映射

---

## **v2.4.1** (2025-12-27)

### Bug 修复
- 修复 `/jmi` 指令不遵循 `send_cover_preview` 配置的问题
- 现在关闭封面预览配置后，`/jmi` 和 `/jm` 都不会发送封面图片

---

## **v2.4.0** (2025-12-27)

### 新增功能
- **封面预览图片** - `/jmi` 和 `/jm` 指令支持发送漫画封面图片
  - `/jmi <ID>` - 现在会同时显示封面图片和详情信息
  - `/jm <ID>` - 当 `send_cover_preview=true` 时发送封面预览
  - 封面缓存到 `{download_dir}/covers/` 目录

### 架构优化
- 新增 `browser.get_album_cover()` 方法用于下载封面

---

## **v2.3.0** (2025-12-27)

### 新增功能
- **收藏夹功能** - 新增 `/jmfav` 命令，查看我的收藏
  - `/jmfav [页码]` - 查看收藏夹（需登录）
  - `/jmfav [页码] [收藏夹ID]` - 查看指定收藏夹
  - 显示收藏夹列表，支持多收藏夹切换

---

## **v2.2.0** (2025-12-27)

### 新增功能
- **登录功能** - 新增账号登录相关命令
  - `/jmlogin <用户名> <密码>` - 登录JM账号
  - `/jmlogout` - 登出账号
  - `/jmstatus` - 查看登录状态
  - 支持在配置中保存凭据，实现自动登录
  - 登录状态持久化保存，重启后自动恢复

### 新增配置项
- `jm_username` - JM账号用户名（可选）
- `jm_password` - JM账号密码（可选）

### 架构优化
- 新增 `core/auth.py` - 认证管理器 `JMAuthManager`
- 支持 cookies 文件持久化存储
- 自动登录和登录状态恢复机制

---

## **v2.1.1** (2025-12-27)

### 架构优化
- **目录结构重构** - 优化 `core/` 模块组织
  - 新增 `core/base/` 子目录，存放基础设施类
  - 将 `config.py` 和 `client.py` 移至 `base/` 目录
  - 改善代码分层，遵循分层架构设计

---

## **v2.1.0** (2025-12-27)

### 新增功能
- **排行榜功能** - 新增 `/jmrank` 命令，支持查看周排行榜和月排行榜
  - `/jmrank week [页码]` - 查看周排行榜
  - `/jmrank month [页码]` - 查看月排行榜
  - 前三名使用🥇🥈🥉特殊显示

### 架构优化
- **模块化重构** - 遵循单一职责原则，拆分核心模块
  - 新增 `client.py` - 客户端管理混入类 `JMClientMixin`
  - 新增 `browser.py` - 浏览查询器 `JMBrowser`（搜索、详情、排行榜）
  - 重构 `downloader.py` - 专注下载功能（下载本子、章节）

---

## **v2.0.1** (2025-12-26)

### Bug 修复
- 修复 `JmAlbumDetail` 属性访问错误，使用 `len(album)` 获取章节数
- 修复 `client_type` 配置错误，正确映射为 `api`/`html`
- 修复 `Comp.File` 文件发送方式
- 修复搜索命令参数处理，支持 AstrBot 参数格式
- 修复搜索 API 调用，使用 `search_site` 和 `iter_id_title_tag`

---

## **v2.0.0** (2025-12-26) - 重大重构

### 架构重构
- 采用模块化设计，代码结构更清晰
- 分离核心逻辑（下载、打包、配置）和工具模块（格式化）
- 使用 `asyncio.to_thread()` 包装同步操作，确保异步兼容性

### 新增功能
- **加密 ZIP 支持** - 使用 `pyzipper` 实现 AES 加密
- **加密 PDF 支持** - 使用 `pymupdf` 实现 PDF 加密
- **章节下载** - 新增 `/jmc` 命令下载单个章节
- **权限控制** - 支持管理员白名单和群组白名单
- **自动清理** - 发送文件后自动删除本地文件
- **封面预览** - 下载前展示漫画详情

### 命令调整
- `/jm <ID>` - 下载完整本子
- `/jmc <ID>` - 下载单个章节（新增）
- `/jms <关键词>` - 搜索漫画
- `/jmi <ID>` - 查看本子详情
- `/jmhelp` - 查看帮助

### 移除功能
- 移除 `/jmimg` 图片预览命令
- 移除 `/jmpdf` PDF 诊断命令
- 移除 `/jmconfig` 配置命令（改用管理面板）
- 移除 `/jmdomain` 域名管理命令
- 移除 `/jmauthor` 作者搜索命令
- 移除 `/jmrecommend` 随机推荐命令

---

## **v1.1.0** (2025-09-20)

### 重大功能更新

- **全新三层下载回退机制** - 显著提高下载成功率
  - 直接客户端下载 → 强制域名配置 → 原始方法回退
  - 智能域名切换，自动处理失效域名
  - 增强的错误处理和重试逻辑

- **作者搜索功能大幅改进**
  - 支持显示作者前 N 部作品列表
  - 智能搜索格式选择
  - 优化搜索结果显示

- **资源管理全面优化**
  - 引入线程池管理
  - 优化内存使用
  - 改进的客户端工厂模式

- **用户体验改善**
  - 更详细的调试信息和日志记录
  - 优化的进度提示和状态反馈

- **代码质量提升**
  - 大幅重构下载逻辑
  - 增强输入验证和异常处理

---

## **v1.0.7** (2025-06-01)

- 新增配置项 `show_cover`，支持控制是否在漫画信息和搜索结果中显示封面图片

---

## **v1.0.6** (2025-05-06)

- 更换文件发送方式，修复文件消息缺少参数问题

---

## **v1.0.5** (2025-05-05)

- 迁移到 AstrBot 官方配置系统，支持在管理面板中配置
- 修复了 API 兼容性问题，使插件适配 AstrBot 最新版本
- 优化了资源管理，现在正确使用 AstrBot 推荐的数据目录
- 改进了错误处理和日志记录
- 添加了线程监控功能

---

## **v1.0.4** (2025-05-05)

- 增加了智能目录识别功能，支持非标准命名的漫画目录
- 改进了图片统计逻辑
- 优化了 `/jmpdf` 命令
- 修复了部分漫画因目录命名问题无法使用 `/jmimg` 命令的问题

---

## **v1.0.3** (2025-05-04)

- 增强了错误处理
- 添加了调试模式
- 添加了网站结构变化的适配
- 修复了 PDF 文件传输失败问题
- 新增图片预览功能和 PDF 文件诊断
- 新增域名测试与自动更新功能

---

## **v1.0.2** (2025-05-03)

- 修复了 PDF 文件传输失败问题
- 新增图片预览功能和 PDF 文件诊断

---

## **v1.0.1** (2025-05-02)

- 增强了错误处理
- 添加了调试模式
- 添加了网站结构变化的适配

---

## **v1.0.0** (2025-05-01)

- 初始版本发布
